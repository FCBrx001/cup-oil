# 参数对比分析预测功能说明

## 功能概述

参数对比分析功能现已支持从数据库获取真实的预测数据，支持多站点预测数据展示，预测数据提前25秒显示，体现真实的预测效果。

⚠️ **重要说明**: 预测数据和实际数据是分开处理的，实际数据来自实时推送，预测数据来自数据库查询。

## 核心特性

### 1. 多站点预测数据支持
- **十字窖#1**: 数据库集合 `阀室1预测数据`
- **十字窖#2**: 数据库集合 `阀室2预测数据`  
- **黄埔**: 数据库集合 `黄埔站预测数据` ✅ 已修正
- **东莞**: 数据库集合 `东莞站预测数据`

### 2. 数据库配置
```javascript
mongo_url: 'mongodb://root:examplepassword@10.1.16.50:9101'
db_name: "计算结果"
```

### 3. 数据格式
```javascript
{
    _id: ObjectId('68591f9412c100b1bedfee5a'),
    time: 1672502400,
    '阀室X预测压力': 3.225,      // X为1或2 
    '阀室X预测温度': 23.6,       // X为1或2
    '黄埔站预测压力': 3.225,     // 黄埔站点
    '黄埔站预测温度': 23.6,      // 黄埔站点
    '东莞站预测压力': 3.225,     // 东莞站点  
    '东莞站预测温度': 23.6       // 东莞站点
}
```

### 4. 时间策略
- **真实数据**: 实时显示当前时间的数据（来自数据推送）
- **预测数据**: 提前25秒显示（5步 × 5秒/步，来自数据库）
- **更新频率**: 每5秒获取一次新的预测数据

## 数据处理逻辑

### 1. 实际数据处理
```javascript
// 来源：管线图组件的真实数据推送
processRealTimeData(data) {
  // 存储到全局历史 → 展示为实际值曲线
  // 时间：当前真实时间
}
```

### 2. 预测数据处理  
```javascript
// 来源：数据库查询（启用预测模式时）
fetchRealPredictionData() {
  // 从数据库获取第5条记录 → 展示为预测值曲线
  // 时间：当前时间 + 25秒（提前显示）
}
```

### 3. 图表展示
- **蓝色实线**: 实际温度数据
- **蓝色虚线**: 预测温度数据（提前25秒）
- **绿色实线**: 实际压力数据  
- **绿色虚线**: 预测压力数据（提前25秒）

## API接口

### 1. 获取单站点当前预测数据
```
GET /prediction/station/:stationName/current
```
**参数**: 
- `stationName`: 站点名称（十字窖#1、十字窖#2、黄埔、东莞）

**响应**:
```json
{
  "success": true,
  "message": "成功获取 黄埔 当前预测数据",
  "data": {
    "pressure": 3.225,
    "temperature": 23.6,
    "dataIndex": 5,
    "totalRecords": 10,
    "stationName": "黄埔",
    "collectionName": "黄埔站预测数据"
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### 2. 获取多站点预测数据（批量）
```
POST /prediction/stations/batch
```
**请求体**:
```json
{
  "stationNames": ["十字窖#1", "十字窖#2", "黄埔", "东莞"],
  "dataType": "current"
}
```

### 3. 获取预测数据序列
```
GET /prediction/station/:stationName/sequence?count=5
```

## 前端实现

### 1. 预测模式控制
```javascript
// 监听预测模式变化
predictionMode: {
  handler(newMode) {
    if (newMode.isEnabled && newMode.valveName) {
      // 启动预测数据模式 - 支持任何站点
      this.startPredictionDataMode();
    } else {
      // 停止预测数据模式
      this.stopPredictionDataMode();
    }
  }
}
```

### 2. 预测数据获取
```javascript
// 每5秒自动获取真实预测数据
startPredictionDataMode() {
  this.predictionDataTimer = setInterval(async () => {
    await this.fetchRealPredictionData();
  }, 5000);
}
```

### 3. 数据存储分离
- **实际数据**: `actualTemperatureData` + `actualPressureData`
- **预测数据**: `predictionTemperatureData` + `predictionPressureData`
- **多站点**: `multiStationData` Map（每站点独立存储）

## 使用流程

### 1. 启动预测模式
1. 用户点击管线图上的任意站点
2. 系统传递`predictionMode.isEnabled = true`
3. 组件开始每5秒获取对应站点的预测数据
4. 预测数据以虚线形式提前25秒显示

### 2. 数据同步显示
- **X轴**: 统一的时间轴
- **实际数据**: 当前时间点显示
- **预测数据**: 当前时间+25秒点显示  
- **效果**: 预测线条"领先"实际线条25秒

### 3. 多站点对比
- 支持同时显示多个站点的实际+预测数据
- 每个站点使用不同颜色区分
- 批量API减少网络请求次数

## 测试验证

运行测试脚本：
```bash
node test_prediction_api.js
```

测试内容：
- ✅ 服务器连接检查
- ✅ 单站点预测数据获取
- ✅ 批量站点预测数据获取  
- ✅ 预测数据序列获取

## 重要注意事项

### 1. 数据源分离
- ❌ 不要混淆实际数据和预测数据的来源
- ✅ 实际数据来自数据推送，预测数据来自数据库查询

### 2. 时间同步
- ❌ 预测数据不使用数据库中的时间戳
- ✅ 预测数据使用计算时间（当前时间+25秒）

### 3. 数据库依赖
- ⚠️ 预测功能需要MongoDB数据库正常运行
- ⚠️ 需要确保各站点的预测数据集合已创建
- ⚠️ 数据库连接超时设置为5秒

### 4. 错误处理
- 单个站点预测失败不影响其他站点
- 网络异常时在控制台显示详细错误信息
- 数据库连接失败时自动降级处理

## 配置要求

- Node.js 环境
- MongoDB 数据库连接（10.1.16.50:9101）
- 预测数据库 `计算结果` 已准备就绪
- 前端支持 axios HTTP 请求

## 更新历史

- **v1.0**: 基础预测功能，支持单站点
- **v2.0**: 多站点预测支持，批量API接口
- **v3.0**: 真实数据库集成，提前25秒显示策略
- **v3.1**: 修正黄埔站集合名称，数据源分离处理 